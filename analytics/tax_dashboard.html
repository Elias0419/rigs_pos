<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIGS Tax & Accounting Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; color: #111; }
        header { background: #111; color: #fff; padding: 14px 18px; }
        header h1 { margin: 0; font-size: 18px; }
        header p { margin: 4px 0 0; font-size: 12px; color: #ddd; }
        main { max-width: 1100px; margin: 16px auto; padding: 0 12px 20px; }
        .card { background: #fff; border: 1px solid #ccc; margin-bottom: 12px; padding: 12px; }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
        .field { display: flex; flex-direction: column; min-width: 160px; gap: 4px; }
        label { font-size: 12px; font-weight: 700; }
        select, input, button { font-size: 13px; padding: 6px 8px; border: 1px solid #888; }
        button { background: #222; color: #fff; cursor: pointer; }
        button.delete { background: #8b0000; border-color: #5a0000; }
        .metrics { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); }
        .metric { border: 1px solid #ddd; background: #fafafa; padding: 10px; }
        .metric .name { font-size: 11px; font-weight: 700; color: #555; text-transform: uppercase; }
        .metric .value { margin-top: 4px; font-size: 24px; font-weight: 700; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; text-align: left; }
        th { background: #eee; }
        .note { font-size: 12px; color: #666; margin-top: 6px; }
    </style>
</head>
<body>
<header>
    <h1>Tax & Accounting Dashboard</h1>
    <p>Quarterly reporting for revenue, COGS, other deductions, and taxable income.</p>
</header>
<main>
    <section class="card">
        <div class="row">
            <div class="field">
                <label for="quarterSelect">Quarter</label>
                <select id="quarterSelect"></select>
            </div>
            <div class="field">
                <button id="refreshBtn">Refresh quarter data</button>
            </div>
        </div>
    </section>

    <section class="card">
        <h2>Quarter Totals</h2>
        <div class="metrics">
            <div class="metric"><div class="name">Revenue</div><div class="value" id="revenue">$0.00</div></div>
            <div class="metric"><div class="name">COGS</div><div class="value" id="cogs">$0.00</div></div>
            <div class="metric"><div class="name">Gross Profit (Revenue - COGS)</div><div class="value" id="grossProfit">$0.00</div></div>
            <div class="metric"><div class="name">Other Expenses</div><div class="value" id="otherExpenses">$0.00</div></div>
            <div class="metric"><div class="name">Taxable Income</div><div class="value" id="taxableIncome">$0.00</div></div>
        </div>
        <div class="note" id="quarterRange"></div>
        <div class="note" id="costWarning"></div>
    </section>

    <section class="card">
        <h2>Add Itemized Deduction</h2>
        <div class="row">
            <div class="field">
                <label for="categoryInput">Category</label>
                <input id="categoryInput" type="text" placeholder="Rent, Utilities, Insurance" />
            </div>
            <div class="field" style="flex: 1; min-width: 220px;">
                <label for="descriptionInput">Description</label>
                <input id="descriptionInput" type="text" placeholder="Optional note for tax form" />
            </div>
            <div class="field">
                <label for="amountInput">Amount</label>
                <input id="amountInput" type="number" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div class="field">
                <button id="addExpenseBtn">Add expense</button>
            </div>
        </div>
    </section>

    <section class="card">
        <h2>Itemized Deductions</h2>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Created</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="expensesBody"></tbody>
        </table>
    </section>
</main>

<script>
const quarterSelect = document.getElementById('quarterSelect');
const refreshBtn = document.getElementById('refreshBtn');
const addExpenseBtn = document.getElementById('addExpenseBtn');
const expensesBody = document.getElementById('expensesBody');

const categoryInput = document.getElementById('categoryInput');
const descriptionInput = document.getElementById('descriptionInput');
const amountInput = document.getElementById('amountInput');

let currentQuarter = null;

function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value || 0);
}

function getCurrentQuarterFromDate() {
    const now = new Date();
    return { year: now.getFullYear(), quarter: Math.floor(now.getMonth() / 3) + 1 };
}

async function loadQuarterOptions() {
    const response = await fetch('/api/tax/quarters');
    const quarters = await response.json();

    const todayQuarter = getCurrentQuarterFromDate();
    let selectedValue = `${todayQuarter.year}-Q${todayQuarter.quarter}`;

    quarterSelect.innerHTML = '';
    for (const item of quarters) {
        const value = `${item.year}-Q${item.quarter}`;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        quarterSelect.appendChild(option);
    }

    const availableValues = [...quarterSelect.options].map(opt => opt.value);
    if (!availableValues.includes(selectedValue) && availableValues.length) {
        selectedValue = availableValues[0];
    }
    quarterSelect.value = selectedValue;
    currentQuarter = parseQuarterValue(selectedValue);
}

function parseQuarterValue(value) {
    const [yearPart, quarterPart] = value.split('-Q');
    return { year: Number(yearPart), quarter: Number(quarterPart) };
}

async function refreshQuarterData() {
    if (!currentQuarter) {
        return;
    }

    const params = new URLSearchParams({
        year: currentQuarter.year,
        quarter: currentQuarter.quarter,
    });

    const response = await fetch(`/api/tax/quarter_summary?${params.toString()}`);
    const data = await response.json();

    document.getElementById('revenue').textContent = formatCurrency(data.totals.revenue);
    document.getElementById('cogs').textContent = formatCurrency(data.totals.cogs);
    document.getElementById('grossProfit').textContent = formatCurrency(data.totals.gross_profit);
    document.getElementById('otherExpenses').textContent = formatCurrency(data.totals.other_expenses);
    document.getElementById('taxableIncome').textContent = formatCurrency(data.totals.taxable_income);

    document.getElementById('quarterRange').textContent = `Range: ${data.totals.start_date} through ${data.totals.end_date}`;
    document.getElementById('costWarning').textContent = data.totals.missing_cost_lines > 0
        ? `Warning: ${data.totals.missing_cost_lines} order item lines are missing cost data, so COGS may be understated.`
        : '';

    renderExpenses(data.itemized_deductions || []);
}

function renderExpenses(expenses) {
    expensesBody.innerHTML = '';

    if (!expenses.length) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5">No itemized deductions entered for this quarter.</td>';
        expensesBody.appendChild(row);
        return;
    }

    for (const expense of expenses) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${expense.category || ''}</td>
            <td>${expense.description || ''}</td>
            <td>${formatCurrency(expense.amount)}</td>
            <td>${expense.created_at || ''}</td>
            <td><button class="delete" data-expense-id="${expense.id}">Delete</button></td>
        `;
        expensesBody.appendChild(row);
    }

    for (const button of expensesBody.querySelectorAll('button.delete')) {
        button.addEventListener('click', async () => {
            const expenseId = button.dataset.expenseId;
            const params = new URLSearchParams({ year: currentQuarter.year, quarter: currentQuarter.quarter });
            const response = await fetch(`/api/tax/expenses/${expenseId}?${params.toString()}`, { method: 'DELETE' });
            if (!response.ok) {
                const result = await response.json();
                alert(result.error || 'Unable to delete expense.');
                return;
            }
            await refreshQuarterData();
        });
    }
}

addExpenseBtn.addEventListener('click', async () => {
    const amount = Number(amountInput.value || 0);
    const payload = {
        year: currentQuarter.year,
        quarter: currentQuarter.quarter,
        category: categoryInput.value || 'Other Expense',
        description: descriptionInput.value || '',
        amount,
    };

    const response = await fetch('/api/tax/expenses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    if (!response.ok) {
        const result = await response.json();
        alert(result.error || 'Unable to add expense.');
        return;
    }

    amountInput.value = '';
    descriptionInput.value = '';
    await refreshQuarterData();
});

quarterSelect.addEventListener('change', () => {
    currentQuarter = parseQuarterValue(quarterSelect.value);
    refreshQuarterData();
});

refreshBtn.addEventListener('click', refreshQuarterData);

(async function init() {
    await loadQuarterOptions();
    await refreshQuarterData();
})();
</script>
</body>
</html>
